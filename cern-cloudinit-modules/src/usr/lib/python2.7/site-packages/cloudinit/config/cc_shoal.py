#################################################################################
# Author: Cristovao Cordeiro <cristovao.cordeiro@cern.ch>			            #
#										                                        #
# Cloud Config module for Shoal service.					                    #
# Documentation in:								                                #
# https://twiki.cern.ch/twiki/bin/view/LCG/CloudInit				            #
#################################################################################
'''
Copyright 2016 CERN.
This software is distributed under the terms of the GNU General Public
Licence version 3 (GPL Version 3).
'''

import os


TEMPLATE = {
	   'cvmfs_config': '/etc/cvmfs/default.local',
	   'shoal_server_url': 'http://localhost:8080/nearest',
	   'default_squid_proxy': 'DIRECT'
}

def handle(_name, cfg, cloud, log, _args):
    """Handler for the cloud-config contextualization of Shoal"""

    if 'shoal' not in cfg:
        return

    shoal_cfg = cfg['shoal']
    local_file = '/etc/shoal/shoal_client.conf'
    cron_file = '/etc/cron.d/shoal-client'

    for param in shoal_cfg:
        if param == 'cron_shoal':
            c_desc = open(cron_file, 'w')
            c_desc.write(shoal_cfg[param]+'\n')
            c_desc.close()
        else:
            TEMPLATE[param] = shoal_cfg[param]

    l_desc = open(local_file, 'w')
    l_desc.write('[general]\n\n')
    for item in TEMPLATE:
        l_desc.write("%s = %s\n" %(item, TEMPLATE[item]))
    l_desc.close()

    os.system('/usr/bin/shoal-client')
